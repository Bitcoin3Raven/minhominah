<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ“ê¸€ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ - ë¯¼í˜¸ë¯¼ì•„ ì„±ì¥ì•¨ë²”</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase ì„¤ì • -->
    <script src="../js/supabase.js"></script>
    
    <style>
        .status-icon { font-size: 1.2rem; }
        .ok { color: #10b981; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">ëŒ“ê¸€ ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸</h1>
        
        <!-- ì—°ê²° ìƒíƒœ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">Supabase ì—°ê²° ìƒíƒœ</h2>
            <div id="connectionStatus" class="text-gray-600">
                <span class="status-icon">â³</span> ì—°ê²° í™•ì¸ ì¤‘...
            </div>
        </div>
        
        <!-- í…Œì´ë¸” ìƒíƒœ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ëŒ“ê¸€ ì‹œìŠ¤í…œ í…Œì´ë¸”</h2>
            <div id="tableStatus" class="space-y-2">
                <div class="text-gray-600">
                    <span class="status-icon">â³</span> í…Œì´ë¸” í™•ì¸ ì¤‘...
                </div>
            </div>
        </div>
        
        <!-- ì‹¤ì‹œê°„ ê¸°ëŠ¥ ìƒíƒœ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ì‹¤ì‹œê°„ ê¸°ëŠ¥ ìƒíƒœ</h2>
            <div id="realtimeStatus" class="space-y-2">
                <div class="text-gray-600">
                    <span class="status-icon">â³</span> ì‹¤ì‹œê°„ ê¸°ëŠ¥ í™•ì¸ ì¤‘...
                </div>
            </div>
        </div>
        
        <!-- í•¨ìˆ˜ ë° íŠ¸ë¦¬ê±° ìƒíƒœ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">í•„ìˆ˜ í•¨ìˆ˜ ìƒíƒœ</h2>
            <div id="functionStatus" class="space-y-2">
                <div class="text-gray-600">
                    <span class="status-icon">â³</span> í•¨ìˆ˜ í™•ì¸ ì¤‘...
                </div>
            </div>
        </div>
        
        <!-- ì „ì²´ ìƒíƒœ ìš”ì•½ -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ì „ì²´ ìƒíƒœ ìš”ì•½</h2>
            <div id="summaryStatus" class="space-y-2">
                <div class="text-gray-600">
                    <span class="status-icon">â³</span> ë¶„ì„ ì¤‘...
                </div>
            </div>
        </div>
        
        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">ë¹ ë¥¸ í•´ê²°</h2>
            <div class="space-y-4">
                <button onclick="showQuickInstall()" 
                        class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 w-full">
                    ğŸš€ ê°„í¸ ì„¤ì¹˜ SQL ë³´ê¸°
                </button>
                <button onclick="checkStatus()" 
                        class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 w-full">
                    ğŸ”„ ìƒíƒœ ë‹¤ì‹œ í™•ì¸
                </button>
            </div>
        </div>
        
        <!-- SQL í‘œì‹œ ëª¨ë‹¬ -->
        <div id="sqlModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
            <div class="flex items-center justify-center min-h-screen p-4">
                <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[80vh] overflow-hidden">
                    <div class="p-6 border-b">
                        <h3 class="text-xl font-semibold">ê°„í¸ ì„¤ì¹˜ SQL</h3>
                    </div>
                    <div class="p-6 overflow-y-auto max-h-[60vh]">
                        <p class="mb-4 text-sm text-gray-600">
                            ì•„ë˜ SQLì„ ë³µì‚¬í•˜ì—¬ Supabase SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”:
                        </p>
                        <pre class="bg-gray-100 p-4 rounded text-sm overflow-x-auto">
-- ëŒ“ê¸€ ì‹œìŠ¤í…œ ê°„í¸ ì„¤ì¹˜
-- ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ Supabase SQL Editorì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”

-- 1. ëˆ„ë½ëœ í…Œì´ë¸” ìƒì„±
CREATE TABLE IF NOT EXISTS comment_likes (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    comment_id UUID NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES auth.users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    UNIQUE(comment_id, user_id)
);

CREATE TABLE IF NOT EXISTS comment_notifications (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    recipient_user_id UUID NOT NULL REFERENCES auth.users(id),
    comment_id UUID NOT NULL REFERENCES comments(id) ON DELETE CASCADE,
    type TEXT CHECK (type IN ('new_comment', 'reply', 'like')),
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. RLS í™œì„±í™”
ALTER TABLE comment_likes ENABLE ROW LEVEL SECURITY;
ALTER TABLE comment_notifications ENABLE ROW LEVEL SECURITY;

-- 3. RLS ì •ì±…
CREATE POLICY "Anyone can view likes" ON comment_likes FOR SELECT USING (true);
CREATE POLICY "Users can manage their likes" ON comment_likes FOR ALL USING (auth.uid() = user_id);
CREATE POLICY "Users view own notifications" ON comment_notifications FOR SELECT USING (auth.uid() = recipient_user_id);
CREATE POLICY "Users update own notifications" ON comment_notifications FOR UPDATE USING (auth.uid() = recipient_user_id);

-- 4. ëŒ“ê¸€ íŠ¸ë¦¬ í•¨ìˆ˜
CREATE OR REPLACE FUNCTION get_comments_tree(p_memory_id UUID)
RETURNS JSON AS $$
DECLARE
    result JSON;
BEGIN
    WITH RECURSIVE comment_tree AS (
        SELECT 
            c.id, c.memory_id, c.user_id, c.parent_comment_id,
            c.content, c.is_edited, c.created_at, c.updated_at,
            p.username, p.full_name, p.avatar_url,
            COUNT(DISTINCT cl.id) as like_count,
            EXISTS(SELECT 1 FROM comment_likes WHERE comment_id = c.id AND user_id = auth.uid()) as is_liked_by_current_user,
            0 as depth
        FROM comments c
        LEFT JOIN profiles p ON c.user_id = p.id
        LEFT JOIN comment_likes cl ON c.id = cl.comment_id
        WHERE c.memory_id = p_memory_id AND c.parent_comment_id IS NULL
        GROUP BY c.id, p.username, p.full_name, p.avatar_url
        
        UNION ALL
        
        SELECT 
            c.id, c.memory_id, c.user_id, c.parent_comment_id,
            c.content, c.is_edited, c.created_at, c.updated_at,
            p.username, p.full_name, p.avatar_url,
            COUNT(DISTINCT cl.id) as like_count,
            EXISTS(SELECT 1 FROM comment_likes WHERE comment_id = c.id AND user_id = auth.uid()) as is_liked_by_current_user,
            ct.depth + 1 as depth
        FROM comments c
        INNER JOIN comment_tree ct ON c.parent_comment_id = ct.id
        LEFT JOIN profiles p ON c.user_id = p.id
        LEFT JOIN comment_likes cl ON c.id = cl.comment_id
        GROUP BY c.id, p.username, p.full_name, p.avatar_url, ct.depth
    )
    SELECT json_agg(row_to_json(comment_tree) ORDER BY created_at) INTO result
    FROM comment_tree;
    
    RETURN COALESCE(result, '[]'::json);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 5. ì‹¤ì‹œê°„ ê¸°ëŠ¥ í™œì„±í™”
DO $$ BEGIN
    ALTER PUBLICATION supabase_realtime ADD TABLE comments;
EXCEPTION WHEN duplicate_object THEN NULL; END $$;

DO $$ BEGIN
    ALTER PUBLICATION supabase_realtime ADD TABLE comment_likes;
EXCEPTION WHEN duplicate_object THEN NULL; END $$;
                        </pre>
                        <button onclick="copySQL()" 
                                class="mt-4 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                            ğŸ“‹ SQL ë³µì‚¬
                        </button>
                    </div>
                    <div class="p-6 border-t">
                        <button onclick="closeSQLModal()" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let statusData = {
            tables: {},
            realtime: {},
            functions: {},
            overall: 'checking'
        };
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ í™•ì¸
        window.addEventListener('DOMContentLoaded', checkStatus);
        
        async function checkStatus() {
            // ì´ˆê¸°í™”
            updateUI('checking');
            
            // 1. ì—°ê²° í™•ì¸
            const connected = await checkConnection();
            if (!connected) return;
            
            // 2. í…Œì´ë¸” í™•ì¸
            await checkTables();
            
            // 3. ì‹¤ì‹œê°„ ê¸°ëŠ¥ í™•ì¸
            await checkRealtime();
            
            // 4. í•¨ìˆ˜ í™•ì¸
            await checkFunctions();
            
            // 5. ì „ì²´ ìƒíƒœ ìš”ì•½
            updateSummary();
        }
        
        async function checkConnection() {
            try {
                const { data, error } = await supabaseClient
                    .from('memories')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                document.getElementById('connectionStatus').innerHTML = 
                    '<span class="status-icon ok">âœ…</span> Supabase ì—°ê²° ì„±ê³µ';
                return true;
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = 
                    `<span class="status-icon error">âŒ</span> ì—°ê²° ì‹¤íŒ¨: ${error.message}`;
                updateUI('error');
                return false;
            }
        }
        
        async function checkTables() {
            const tables = ['comments', 'comment_likes', 'comment_notifications'];
            const tableStatus = document.getElementById('tableStatus');
            let html = '';
            
            for (const table of tables) {
                try {
                    const { count, error } = await supabaseClient
                        .from(table)
                        .select('*', { count: 'exact', head: true });
                    
                    if (error) {
                        statusData.tables[table] = false;
                        html += `<div><span class="status-icon error">âŒ</span> ${table} - í…Œì´ë¸” ì—†ìŒ</div>`;
                    } else {
                        statusData.tables[table] = true;
                        html += `<div><span class="status-icon ok">âœ…</span> ${table} - ì •ìƒ (${count || 0}ê°œ ë ˆì½”ë“œ)</div>`;
                    }
                } catch (e) {
                    statusData.tables[table] = false;
                    html += `<div><span class="status-icon error">âŒ</span> ${table} - í™•ì¸ ì‹¤íŒ¨</div>`;
                }
            }
            
            tableStatus.innerHTML = html;
        }
        
        async function checkRealtime() {
            const realtimeStatus = document.getElementById('realtimeStatus');
            
            try {
                // ì‹¤ì‹œê°„ êµ¬ë… í…ŒìŠ¤íŠ¸
                const channel = supabaseClient
                    .channel('test-channel')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'comments' },
                        () => {}
                    )
                    .subscribe();
                
                // êµ¬ë… ìƒíƒœ í™•ì¸
                setTimeout(() => {
                    const status = channel.state;
                    if (status === 'SUBSCRIBED') {
                        statusData.realtime.comments = true;
                        realtimeStatus.innerHTML = 
                            '<span class="status-icon ok">âœ…</span> ì‹¤ì‹œê°„ ê¸°ëŠ¥ í™œì„±í™”ë¨';
                    } else {
                        statusData.realtime.comments = false;
                        realtimeStatus.innerHTML = 
                            '<span class="status-icon warning">âš ï¸</span> ì‹¤ì‹œê°„ ê¸°ëŠ¥ ë¹„í™œì„±í™” (ì„¤ì • í•„ìš”)';
                    }
                    channel.unsubscribe();
                }, 2000);
            } catch (error) {
                statusData.realtime.comments = false;
                realtimeStatus.innerHTML = 
                    '<span class="status-icon error">âŒ</span> ì‹¤ì‹œê°„ ê¸°ëŠ¥ í™•ì¸ ì‹¤íŒ¨';
            }
        }
        
        async function checkFunctions() {
            const functionStatus = document.getElementById('functionStatus');
            
            try {
                // get_comments_tree í•¨ìˆ˜ í…ŒìŠ¤íŠ¸
                const { data, error } = await supabaseClient
                    .rpc('get_comments_tree', { p_memory_id: '00000000-0000-0000-0000-000000000000' });
                
                if (error) {
                    statusData.functions.get_comments_tree = false;
                    functionStatus.innerHTML = 
                        '<span class="status-icon error">âŒ</span> get_comments_tree í•¨ìˆ˜ - ì—†ìŒ';
                } else {
                    statusData.functions.get_comments_tree = true;
                    functionStatus.innerHTML = 
                        '<span class="status-icon ok">âœ…</span> get_comments_tree í•¨ìˆ˜ - ì •ìƒ';
                }
            } catch (e) {
                statusData.functions.get_comments_tree = false;
                functionStatus.innerHTML = 
                    '<span class="status-icon error">âŒ</span> í•¨ìˆ˜ í™•ì¸ ì‹¤íŒ¨';
            }
        }
        
        function updateSummary() {
            const summaryStatus = document.getElementById('summaryStatus');
            
            // ì „ì²´ ìƒíƒœ ê³„ì‚°
            const tableCount = Object.values(statusData.tables).filter(v => v).length;
            const hasRealtime = Object.values(statusData.realtime).some(v => v);
            const hasFunction = statusData.functions.get_comments_tree;
            
            let html = '';
            let needsInstall = false;
            
            if (tableCount === 3 && hasFunction) {
                html = '<div class="text-green-600 font-semibold">' +
                       '<span class="status-icon ok">âœ…</span> ëŒ“ê¸€ ì‹œìŠ¤í…œì´ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤!</div>';
                
                if (!hasRealtime) {
                    html += '<div class="text-yellow-600 mt-2">' +
                           '<span class="status-icon warning">âš ï¸</span> ì‹¤ì‹œê°„ ê¸°ëŠ¥ë§Œ ì¶”ê°€ ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.</div>';
                }
            } else {
                needsInstall = true;
                html = '<div class="text-red-600 font-semibold">' +
                       '<span class="status-icon error">âŒ</span> ëŒ“ê¸€ ì‹œìŠ¤í…œ ì„¤ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>';
                
                html += '<div class="mt-2 text-sm text-gray-600">ëˆ„ë½ëœ í•­ëª©:</div>';
                html += '<ul class="mt-1 text-sm text-gray-600 list-disc list-inside">';
                
                if (!statusData.tables.comment_likes) html += '<li>comment_likes í…Œì´ë¸”</li>';
                if (!statusData.tables.comment_notifications) html += '<li>comment_notifications í…Œì´ë¸”</li>';
                if (!hasFunction) html += '<li>get_comments_tree í•¨ìˆ˜</li>';
                
                html += '</ul>';
            }
            
            summaryStatus.innerHTML = html;
        }
        
        function updateUI(status) {
            if (status === 'checking') {
                // ì´ˆê¸° ìƒíƒœë¡œ ë¦¬ì…‹
                ['tableStatus', 'realtimeStatus', 'functionStatus', 'summaryStatus'].forEach(id => {
                    document.getElementById(id).innerHTML = 
                        '<div class="text-gray-600"><span class="status-icon">â³</span> í™•ì¸ ì¤‘...</div>';
                });
            }
        }
        
        function showQuickInstall() {
            document.getElementById('sqlModal').classList.remove('hidden');
        }
        
        function closeSQLModal() {
            document.getElementById('sqlModal').classList.add('hidden');
        }
        
        function copySQL() {
            const sqlText = document.querySelector('#sqlModal pre').textContent;
            navigator.clipboard.writeText(sqlText).then(() => {
                alert('SQLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            });
        }
    </script>
</body>
</html>
