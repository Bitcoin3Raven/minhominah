<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>민호민아 - Supabase 연동 테스트</title>
    
    <!-- Supabase 클라이언트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- 프로젝트 설정 -->
    <script src="../config/supabase.js"></script>
    
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        input, button {
            margin: 5px 0;
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        #userInfo {
            background: #e9ecef;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎈 민호민아 성장 앨범 - Supabase 테스트</h1>
        
        <!-- 연결 상태 -->
        <div class="section">
            <h2>1. Supabase 연결 상태</h2>
            <div id="connectionStatus" class="status info">연결 확인 중...</div>
        </div>
        
        <!-- 인증 테스트 -->
        <div class="section">
            <h2>2. 인증 테스트</h2>
            <div id="authStatus" class="status info">로그인하지 않음</div>
            <div id="userInfo" style="display:none;"></div>
            
            <h3>회원가입</h3>
            <input type="email" id="signupEmail" placeholder="이메일">
            <input type="password" id="signupPassword" placeholder="비밀번호">
            <button onclick="signUp()">회원가입</button>
            
            <h3>로그인</h3>
            <input type="email" id="loginEmail" placeholder="이메일">
            <input type="password" id="loginPassword" placeholder="비밀번호">
            <button onclick="signIn()">로그인</button>
            <button onclick="signOut()" style="background: #dc3545;">로그아웃</button>
        </div>
        
        <!-- 데이터 테스트 -->
        <div class="section">
            <h2>3. 데이터 테스트</h2>
            <h3>테스트 메모리 생성</h3>
            <input type="text" id="memoryTitle" placeholder="제목 (예: 민호 첫 생일)">
            <input type="date" id="memoryDate">
            <textarea id="memoryDescription" placeholder="설명" style="width: 100%; height: 100px;"></textarea>
            <button onclick="createMemory()">메모리 생성</button>
            
            <h3>메모리 목록</h3>
            <button onclick="loadMemories()">메모리 불러오기</button>
            <div id="memoriesList"></div>
        </div>
    </div>
    
    <script>
        // 전역 변수
        let currentUser = null;
        
        // 페이지 로드시 초기화
        window.onload = async function() {
            // Supabase 연결 확인
            checkConnection();
            
            // 현재 세션 확인
            if (supabaseClient) {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session) {
                    currentUser = session.user;
                    updateAuthStatus(true);
                }
            }
        };
        
        // Supabase 연결 상태 확인
        function checkConnection() {
            const status = document.getElementById('connectionStatus');
            if (supabaseClient) {
                status.className = 'status success';
                status.textContent = '✅ Supabase 연결 성공!';
            } else {
                status.className = 'status error';
                status.textContent = '❌ Supabase 연결 실패 - config/supabase.js 파일의 설정을 확인하세요.';
            }
        }
        
        // 회원가입
        async function signUp() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            
            if (!email || !password) {
                alert('이메일과 비밀번호를 입력하세요.');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                alert('회원가입 성공! 이메일을 확인하세요.');
                document.getElementById('signupEmail').value = '';
                document.getElementById('signupPassword').value = '';
            } catch (error) {
                alert('회원가입 실패: ' + error.message);
            }
        }
        
        // 로그인
        async function signIn() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                alert('이메일과 비밀번호를 입력하세요.');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                
                if (error) throw error;
                
                currentUser = data.user;
                updateAuthStatus(true);
                document.getElementById('loginEmail').value = '';
                document.getElementById('loginPassword').value = '';
            } catch (error) {
                alert('로그인 실패: ' + error.message);
            }
        }
        
        // 로그아웃
        async function signOut() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                updateAuthStatus(false);
            } catch (error) {
                alert('로그아웃 실패: ' + error.message);
            }
        }
        
        // 인증 상태 업데이트
        function updateAuthStatus(isLoggedIn) {
            const authStatus = document.getElementById('authStatus');
            const userInfo = document.getElementById('userInfo');
            
            if (isLoggedIn && currentUser) {
                authStatus.className = 'status success';
                authStatus.textContent = '✅ 로그인됨';
                userInfo.style.display = 'block';
                userInfo.innerHTML = `
                    <strong>사용자 정보:</strong><br>
                    이메일: ${currentUser.email}<br>
                    ID: ${currentUser.id}
                `;
            } else {
                authStatus.className = 'status info';
                authStatus.textContent = '로그인하지 않음';
                userInfo.style.display = 'none';
            }
        }
        
        // 메모리 생성
        async function createMemory() {
            if (!currentUser) {
                alert('먼저 로그인하세요.');
                return;
            }
            
            const title = document.getElementById('memoryTitle').value;
            const date = document.getElementById('memoryDate').value;
            const description = document.getElementById('memoryDescription').value;
            
            if (!title || !date) {
                alert('제목과 날짜는 필수입니다.');
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('memories')
                    .insert([
                        {
                            title: title,
                            memory_date: date,
                            description: description,
                            created_by: currentUser.id
                        }
                    ]);
                
                if (error) throw error;
                
                alert('메모리가 생성되었습니다!');
                document.getElementById('memoryTitle').value = '';
                document.getElementById('memoryDate').value = '';
                document.getElementById('memoryDescription').value = '';
                loadMemories();
            } catch (error) {
                alert('메모리 생성 실패: ' + error.message);
            }
        }
        
        // 메모리 목록 불러오기
        async function loadMemories() {
            try {
                const { data, error } = await supabaseClient
                    .from('memories')
                    .select('*')
                    .order('memory_date', { ascending: false });
                
                if (error) throw error;
                
                const memoriesList = document.getElementById('memoriesList');
                if (data && data.length > 0) {
                    memoriesList.innerHTML = '<h4>저장된 메모리:</h4>' + 
                        data.map(memory => `
                            <div style="border: 1px solid #ddd; padding: 10px; margin: 5px 0; border-radius: 5px;">
                                <strong>${memory.title}</strong><br>
                                날짜: ${memory.memory_date}<br>
                                ${memory.description ? '설명: ' + memory.description : ''}
                            </div>
                        `).join('');
                } else {
                    memoriesList.innerHTML = '<p>저장된 메모리가 없습니다.</p>';
                }
            } catch (error) {
                alert('메모리 불러오기 실패: ' + error.message);
                document.getElementById('memoriesList').innerHTML = 
                    '<p class="error">테이블이 없거나 접근 권한이 없습니다. Supabase 대시보드에서 테이블을 생성하세요.</p>';
            }
        }
    </script>
</body>
</html>
