<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실시간 기능 테스트 - 민호민아 성장앨범</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Supabase 설정 -->
    <script src="../js/supabase.js"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">실시간 기능 테스트</h1>
        
        <!-- 연결 상태 -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">연결 상태</h2>
            <div id="connectionStatus" class="text-gray-600">
                연결 확인 중...
            </div>
        </div>
        
        <!-- 실시간 구독 테스트 -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">실시간 구독 테스트</h2>
            
            <div class="space-y-4">
                <div>
                    <button onclick="subscribeToComments()" 
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                        댓글 테이블 구독 시작
                    </button>
                    <span id="commentsStatus" class="ml-4 text-sm text-gray-600"></span>
                </div>
                
                <div>
                    <button onclick="subscribeToLikes()" 
                            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                        좋아요 테이블 구독 시작
                    </button>
                    <span id="likesStatus" class="ml-4 text-sm text-gray-600"></span>
                </div>
                
                <div>
                    <button onclick="unsubscribeAll()" 
                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        모든 구독 해제
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 테스트 데이터 생성 -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">테스트 데이터 생성</h2>
            
            <div class="space-y-4">
                <div>
                    <input type="text" id="testComment" placeholder="테스트 댓글 내용" 
                           class="px-4 py-2 border rounded w-full mb-2">
                    <button onclick="createTestComment()" 
                            class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">
                        테스트 댓글 생성
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 실시간 이벤트 로그 -->
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">실시간 이벤트 로그</h2>
            <div id="eventLog" class="space-y-2 max-h-96 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">이벤트 대기 중...</div>
            </div>
            <button onclick="clearLog()" 
                    class="mt-4 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">
                로그 지우기
            </button>
        </div>
    </div>
    
    <script>
        let channels = {};
        
        // 연결 상태 확인
        async function checkConnection() {
            try {
                const { data, error } = await supabaseClient
                    .from('memories')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                
                document.getElementById('connectionStatus').innerHTML = `
                    <span class="text-green-600 font-semibold">✅ Supabase 연결 성공</span>
                `;
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = `
                    <span class="text-red-600 font-semibold">❌ 연결 실패: ${error.message}</span>
                `;
            }
        }
        
        // 댓글 테이블 구독
        function subscribeToComments() {
            if (channels.comments) {
                addLog('이미 댓글 테이블을 구독 중입니다.', 'warning');
                return;
            }
            
            channels.comments = supabaseClient
                .channel('comments-channel')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'comments' },
                    (payload) => {
                        addLog(`댓글 이벤트: ${payload.eventType}`, 'success');
                        console.log('댓글 변경:', payload);
                    }
                )
                .subscribe((status) => {
                    document.getElementById('commentsStatus').textContent = 
                        status === 'SUBSCRIBED' ? '✅ 구독 중' : `상태: ${status}`;
                    
                    if (status === 'SUBSCRIBED') {
                        addLog('댓글 테이블 실시간 구독 시작', 'info');
                    }
                });
        }
        
        // 좋아요 테이블 구독
        function subscribeToLikes() {
            if (channels.likes) {
                addLog('이미 좋아요 테이블을 구독 중입니다.', 'warning');
                return;
            }
            
            channels.likes = supabaseClient
                .channel('likes-channel')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'comment_likes' },
                    (payload) => {
                        addLog(`좋아요 이벤트: ${payload.eventType}`, 'success');
                        console.log('좋아요 변경:', payload);
                    }
                )
                .subscribe((status) => {
                    document.getElementById('likesStatus').textContent = 
                        status === 'SUBSCRIBED' ? '✅ 구독 중' : `상태: ${status}`;
                    
                    if (status === 'SUBSCRIBED') {
                        addLog('좋아요 테이블 실시간 구독 시작', 'info');
                    }
                });
        }
        
        // 모든 구독 해제
        function unsubscribeAll() {
            Object.values(channels).forEach(channel => {
                channel.unsubscribe();
            });
            channels = {};
            document.getElementById('commentsStatus').textContent = '';
            document.getElementById('likesStatus').textContent = '';
            addLog('모든 실시간 구독 해제됨', 'info');
        }
        
        // 테스트 댓글 생성
        async function createTestComment() {
            const content = document.getElementById('testComment').value;
            if (!content) {
                alert('댓글 내용을 입력하세요.');
                return;
            }
            
            try {
                // 현재 사용자 확인
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    alert('로그인이 필요합니다.');
                    return;
                }
                
                // 첫 번째 추억 가져오기 (테스트용)
                const { data: memories } = await supabaseClient
                    .from('memories')
                    .select('id')
                    .limit(1);
                
                if (!memories || memories.length === 0) {
                    alert('추억이 없습니다. 먼저 추억을 생성하세요.');
                    return;
                }
                
                // 댓글 생성
                const { data, error } = await supabaseClient
                    .from('comments')
                    .insert({
                        memory_id: memories[0].id,
                        user_id: user.id,
                        content: content
                    })
                    .select();
                
                if (error) throw error;
                
                addLog('테스트 댓글 생성 성공', 'success');
                document.getElementById('testComment').value = '';
            } catch (error) {
                addLog(`댓글 생성 실패: ${error.message}`, 'error');
            }
        }
        
        // 이벤트 로그 추가
        function addLog(message, type = 'info') {
            const logDiv = document.getElementById('eventLog');
            const time = new Date().toLocaleTimeString();
            const colors = {
                info: 'text-blue-600',
                success: 'text-green-600',
                warning: 'text-yellow-600',
                error: 'text-red-600'
            };
            
            const logEntry = document.createElement('div');
            logEntry.className = `${colors[type]} border-b border-gray-200 pb-1`;
            logEntry.innerHTML = `[${time}] ${message}`;
            
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // 로그 지우기
        function clearLog() {
            document.getElementById('eventLog').innerHTML = 
                '<div class="text-gray-500">이벤트 대기 중...</div>';
        }
        
        // 페이지 로드 시 연결 확인
        checkConnection();
        
        // 실시간 구독 가능 테이블 확인
        async function checkRealtimeTables() {
            try {
                const { data, error } = await supabaseClient.rpc('get_realtime_tables');
                if (data) {
                    console.log('실시간 구독 가능 테이블:', data);
                    addLog(`실시간 구독 가능 테이블: ${data.length}개`, 'info');
                }
            } catch (error) {
                // RPC 함수가 없을 수도 있음
                console.log('실시간 테이블 확인 스킵');
            }
        }
        
        checkRealtimeTables();
    </script>
</body>
</html>
